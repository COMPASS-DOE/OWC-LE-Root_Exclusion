},
NH3_flag = if (NH3_r2 <= r2_cutoff) {
"NH3 r2 low"
} else {
""
},
PO4_flag = if (PO4_r2 <= r2_cutoff) {
"PO4 r2 low"
} else {
""
},
SO4_flag = if (SO4_r2 <= r2_cutoff) {
"SO4 r2 low"
} else {
""
},
NO2_flag = if (NO2_r2 <= r2_cutoff) {
"NO2 r2 low"
} else {
""
}
)
#check on the reduction efficiency for the NOx test:
#Pull out test stds
red_eff <- df_all %>%
filter(Sample_Name %in% c("Nitrate Standard", "Nitrite Standard"))
str(red_eff)
View(red_eff)
red_eff_wide<-red_eff%>%pivot_wide(names_from=Test,
Values_from=Conc)
library(lubridate)
red_eff_wide<-red_eff%>%pivot_wide(names_from=Test,
Values_from=Conc)
library(tidyr)
red_eff_wide<-red_eff%>%pivot_wide(names_from=Test,
Values_from=Conc)
library(dplyr)
red_eff_wide<-red_eff%>%pivot_wide(names_from=Test,
Values_from=Conc)
red_eff_wide<-red_eff%>%pivot_wider(names_from=Test,
Values_from=Conc)
red_eff_wide<-red_eff%>%pivot_wider(names_from=Test,
values_from=Conc)
red_eff_wide<-red_eff%>%pivot_wider(names_from=Test,
values_from=Conc)%>%
mutate(Rum_Time=as.POSIXct(Run_Time, format ="YYYY-mm-dd HH:MM"))
red_eff_wide<-red_eff%>%pivot_wider(names_from=Test,
values_from=Conc)%>%
mutate(Rum_Time=as.POSIXct(Run_Time, format ="YYYY-mm-dd HH:MM"))%>%
group_by(Run_Time)
red_eff_wide<-red_eff%>%pivot_wider(names_from=Test,
values_from=Conc)%>%
mutate(Rum_Time=as.POSIXct(Run_Time, format ="YYYY-mm-dd HH:MM"))%>%
group_by(Run_Time) %>%
mutate(red_eff="Nitrate Standard"/"Nitrite Standard")
View(red_eff_wide)
str(Run_Time)
str(red_eff)
red_eff_wide<-red_eff%>%pivot_wider(names_from=Test,
values_from=Conc)%>%
mutate(Run_Time=as.POSIXct(Run_Time, format ="YYYY-mm-dd HH:MM"))
str(red_eff_wide)
red_eff_wide<-red_eff%>%pivot_wider(names_from=Sample_name,
values_from=Conc)%>%
mutate(Run_Time=as.POSIXct(Run_Time, format ="%Y-%m-%d %H:%M"))%>%
group_by(Run_Time) %>%
mutate(red_eff="Nitrate Standard"/"Nitrite Standard")# RBP correcting calculation for def
red_eff_wide<-red_eff%>%pivot_wider(names_from=Sample_Name,
values_from=Conc)%>%
mutate(Run_Time=as.POSIXct(Run_Time, format ="%Y-%m-%d %H:%M"))%>%
group_by(Run_Time) %>%
mutate(red_eff="Nitrate Standard"/"Nitrite Standard")# RBP correcting calculation for def
red_eff_wide<-red_eff%>%pivot_wider(names_from=Sample_Name,
values_from=Conc)%>%
mutate(Run_Time=as.POSIXct(Run_Time, format ="%Y-%m-%d %H:%M"))
str( red_eff_wide)
red_eff_wide<-red_eff%>%pivot_wider(names_from=Sample_Name,
values_from=Conc)
red_eff_calc <- data.frame(
red_eff = red_eff$Conc[seq(1, nrow(red_eff), 2)] /
red_eff$Conc[seq(2, nrow(red_eff), 2)]) # RBP correcting calculation for def
red_eff_calc <- data.frame(
red_eff = red_eff$Conc[seq(1, nrow(red_eff), 2)] /
red_eff$Conc[seq(2, nrow(red_eff), 2)],
mutate = mutate(red_eff = `Nitrate Standard` / `Nitrite Standard`)) # RBP correcting calculation for def
View(red_eff_calc)
str(df_all)
head(df_all)
#| include: false
require(pacman)
p_load(tidyverse,
janitor,
parsedate,
lubridate,
cowplot,
purrr,
readr,
googledrive,
zoo,
dplyr,
stringr,
purrr,
googlesheets4,
arrow,
ggplot2,
ggpubr,
data.table,
patchwork,
sjPlot,
Metrics,
yardstick,
lme4,
ggpmisc,
matrix,
rlang,
scales,
range,
randomForest,
pdp)
# Set ggplot theme
theme_set(theme_bw())
plot_gwl_doy<-ggplot(df_L1_sap_vps_gw, aes(x = datetime, y = gw_hour)) +
geom_point(position = position_dodge(width = 0.5)) +
geom_ribbon(aes(ymin = gw_hour - IQR_gwl , ymax = gw_hour + IQR_gwl ),
alpha = 0.2, linetype="blank") +
geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray") +
geom_vline(xintercept = season_division_dates, linetype = "dashed", color = "darkgray", size = 0.5) +
# geom_segment(data = data.frame(datetime = highlight_days),
#           aes(x = datetime, xend = datetime,
#               y = 0.25, yend = 0.2),
#           color = "red",size=1.2,
#           arrow = arrow(length = unit(0.5, "cm"))) +
labs(x = NULL, y = "GW level\n cm") +
theme_bw() +
scale_x_datetime(limits = c(x_min, x_max),
breaks = seq(x_min, x_max, by = "20 days"))+
scale_y_continuous(limits = c(-50, 25)) +
theme(legend.position = "none",
panel.grid = element_blank(),
text = element_text(size = 20),
axis.text.x = element_blank())
plot_gwl_doy<-ggplot(df_one_year, aes(x = datetime, y = median_gwl )) +
geom_point(position = position_dodge(width = 0.5)) +
geom_ribbon(aes(ymin = median_gwl  - IQR_gwl , ymax = median_gwl  + IQR_gwl ),
alpha = 0.2, linetype="blank") +
geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray") +
geom_vline(xintercept = season_division_dates, linetype = "dashed", color = "darkgray", size = 0.5) +
# geom_segment(data = data.frame(datetime = highlight_days),
#           aes(x = datetime, xend = datetime,
#               y = 0.25, yend = 0.2),
#           color = "red",size=1.2,
#           arrow = arrow(length = unit(0.5, "cm"))) +
labs(x = NULL, y = "GW level\n cm") +
theme_bw() +
scale_x_datetime(limits = c(x_min, x_max),
breaks = seq(x_min, x_max, by = "20 days"))+
scale_y_continuous(limits = c(-50, 25)) +
theme(legend.position = "none",
panel.grid = element_blank(),
text = element_text(size = 20),
axis.text.x = element_blank())
plot_swc_doy<-ggplot(df_one_year, aes(x = datetime, y = median_SWC, color = Treat)) +
geom_point(position = position_dodge(width = 0.5)) +
geom_ribbon(aes(ymin = median_SWC - IQR_SWC, ymax = median_SWC + IQR_SWC, fill = Treat),
alpha = 0.2, linetype="blank") +
geom_hline(yintercept = 0.4, linetype = "dashed", color = "darkgray") +
geom_vline(xintercept = season_division_dates, linetype = "dashed", color = "darkgray", linewidth = 0.5) +
scale_color_manual(values = treatment_colors) +
scale_fill_manual(values = treatment_colors)  +
#geom_segment(data = data.frame(datetime = highlight_days),
#           aes(x = datetime, xend = datetime,
#               y = 0.65, yend = 0.6),
#           color = "red",size=1.2,
#           arrow = arrow(length = unit(0.1, "cm"))) +
labs(x = NULL, y = bquote(atop(.( "Soil moisture" ), ~m^3 ~ m^{-3})), color = "Treatment", fill = "Treatment") +
theme_bw() +
scale_x_datetime(limits = c(x_min, x_max),
breaks = seq(x_min, x_max, by = "20 days")) +
ylim(c(0.1, 0.8)) +
theme(legend.position =  c(0.1, 0.3),
panel.grid = element_blank(),
text = element_text(size = 20),
axis.text.x = element_blank())
#  df with all data for flux median IQR per day/hour
df_one_year<-df_summary_hour%>%filter(datetime<="2025-01-14 16:00:00"&datetime>="2024-04-05 15:00:00")
2006-1986
file.exists("df_root_flux_2026.rds")
ggplot(df, aes(x = hour, y = !!sym(yvar), color = Treat, fill = Treat)) +
annotate("rect", xmin = 19, xmax = 24, ymin = -Inf, ymax = Inf,
fill = "grey80", alpha = 0.4, linetype = "dashed") +
annotate("rect", xmin = 0, xmax = 5, ymin = -Inf, ymax = Inf,
fill = "grey80", alpha = 0.4, linetype = "dashed") +
geom_hline(yintercept = 0, linetype = "dotted", color = "black") +
geom_vline(xintercept = c(5, 19), linetype = "dashed", color = "darkgrey") +
geom_ribbon(aes(ymin = !!sym(ymin_var), ymax = !!sym(ymax_var)),
alpha = 0.25, color = NA) +
geom_line(size = 1)
library(ggplot2)
res_df <- do.call(rbind, lapply(names(model_list), function(tr){
data.frame(
Residuals = resid(model_list[[tr]]),
Treatment = tr
)
}))
# -----------------------------
#  Summarise and scale data
# -----------------------------
df_mixed <- L1_flux %>%
mutate(Date = as.Date(datetime)) %>%
group_by(Date, Treat, PORT) %>%
summarise(
FCH4    = median(FCH4, na.rm = TRUE),
FCO2    = median(FCO2, na.rm = TRUE),
SapFlow = median(Js_kgcms, na.rm = TRUE),
Rain    = sum(rain_sum, na.rm = TRUE),
Temp    = median(TS_1, na.rm = TRUE),
SWC     = median(SWC_1, na.rm = TRUE),
GWL     = median(gwl_median, na.rm = TRUE),
VPD     = median(VPD_hour, na.rm = TRUE),
.groups = "drop"
) %>%
filter(complete.cases(.)) %>%
ungroup()
# reading flux, sap, and L1 data created and QAQCedin a separated script
df_root_flux_2026 <- readRDS("df_root_flux_2026.rds")
df_ALL_sap_Js <- readRDS("df_ALL_sap_Js.rds")
df_L1_root <- readRDS("df_L1_root.rds")
# merging gw, vpd with sap FOR FIG 2
df_L1_sap_vps_gw<-df_ALL_sap_Js%>%left_join(df_L1_root, by = "datetime")
df_L1_sap_vps_gw<-df_L1_sap_vps_gw%>%
mutate(gw_hour=100*gwl_median,              # transforming m to cm
DATE = as.Date(datetime, format = "%Y-%m-%d"),
DOY = yday(datetime))
# merging gw, vpd with sap dfs for RF
df_L1_datetime<- df_L1_sap_vps_gw %>%
select(-Sensor_ID) %>%
group_by(datetime) %>%
summarise(
across(where(is.numeric), ~ mean(.x, na.rm = TRUE)),
across(where(~ !is.numeric(.x)), ~ first(.x)),
.groups = "drop"
)
df_L1_filtered<-df_L1_datetime%>%dplyr::select(-c(DATE,DOY))
df_flux_hour<-df_root_flux_2026%>%left_join(df_L1_filtered, by = "datetime")
L1_flux<-df_flux_hour%>%mutate(season = case_when(
DATE >= as.Date("2024-03-20") & DATE < as.Date("2024-06-22") ~ "Spring",
DATE >= as.Date("2024-06-22") & DATE < as.Date("2024-09-24") ~ "Summer",
DATE >= as.Date("2024-09-24") & DATE < as.Date("2024-12-22") ~ "Fall",
DATE >= as.Date("2024-12-22") & DATE < as.Date("2025-03-20") ~ "Winter",
DATE >= as.Date("2025-03-20") & DATE < as.Date("2025-06-22") ~ "Spring",
DATE >= as.Date("2025-06-22") & DATE < as.Date("2025-09-24") ~ "Summer"
))
#averaging data per date-hour and treatment
df_summary_hour <- L1_flux%>%
group_by(datetime,
Treat,
season) %>%
dplyr::summarise(mean_FCH4 = mean((FCH4), na.rm = TRUE),
sd_FCH4 = sd((FCH4), na.rm = TRUE),
median_FCH4 = median((FCH4), na.rm = TRUE),
IQR_FCH4 = IQR((FCH4), na.rm = TRUE),
mean_SWC = mean((SWC_1), na.rm = TRUE),
sd_SWC = sd((SWC_1), na.rm = TRUE),
median_SWC = median((SWC_1), na.rm = TRUE),
IQR_SWC = IQR((SWC_1), na.rm = TRUE),
mean_TS = mean((TS_1), na.rm = TRUE),
sd_TS = sd((TS_1), na.rm = TRUE),
median_TS = median((TS_1), na.rm = TRUE),
IQR_TS = IQR((TS_1), na.rm = TRUE),
mean_FCO2 = mean((FCO2), na.rm = TRUE),
sd_FCO2 = sd((FCO2), na.rm = TRUE),
median_FCO2 = median((FCO2), na.rm = TRUE),
IQR_FCO2 = IQR((FCO2), na.rm = TRUE),
mean_gwl = mean((gwl_median), na.rm = TRUE), #cm
sd_gwl = sd((gwl_median), na.rm = TRUE),
median_gwl = median((gwl_median), na.rm = TRUE),
IQR_gwl = IQR((gwl_median), na.rm = TRUE),
mean_sap =  mean(Js_kgcms, na.rm = TRUE),
sd_sap =  sd(Js_kgcms, na.rm = TRUE),
median_sap =  median(Js_kgcms, na.rm = TRUE),
IQR_sap=IQR(Js_kgcms, na.rm = TRUE),
mean_vpd = mean((VPD_hour), na.rm = TRUE),
sd_vpd = sd((VPD_hour), na.rm = TRUE),
median_vpd = median((VPD_hour), na.rm = TRUE),
IQR_vpd = IQR((VPD_hour), na.rm = TRUE),
n_obs = n()
) %>%
ungroup()
df_rain<-df_L1_datetime%>%dplyr::select(rain_sum, datetime)
df_gamm<-df_summary_hour%>%left_join(df_rain, by="datetime")
# -----------------------------
#  Summarise and scale data
# -----------------------------
df_mixed <- L1_flux %>%
mutate(Date = as.Date(datetime)) %>%
group_by(Date, Treat, PORT) %>%
summarise(
FCH4    = median(FCH4, na.rm = TRUE),
FCO2    = median(FCO2, na.rm = TRUE),
SapFlow = median(Js_kgcms, na.rm = TRUE),
Rain    = sum(rain_sum, na.rm = TRUE),
Temp    = median(TS_1, na.rm = TRUE),
SWC     = median(SWC_1, na.rm = TRUE),
GWL     = median(gwl_median, na.rm = TRUE),
VPD     = median(VPD_hour, na.rm = TRUE),
.groups = "drop"
) %>%
filter(complete.cases(.)) %>%
ungroup()
df_mixed$Treat <- factor(df_mixed$Treat)
df_mixed$PORT  <- factor(df_mixed$PORT)
cont_vars <- c("FCH4","FCO2","SapFlow","Rain","Temp","SWC","GWL","VPD")
df_mixed_scaled <- df_mixed
df_mixed_scaled[cont_vars] <- scale(df_mixed[cont_vars])
# -----------------------------
#  Models separated by Treatment
# -----------------------------
treatments <- levels(df_mixed_scaled$Treat)
model_list <- list()
for(tr in treatments){
df_sub <- df_mixed_scaled %>% filter(Treat == tr)
model <- lmer(FCH4 ~ Temp + SWC + GWL + VPD + SapFlow + Rain + FCO2 +
(1|PORT) + (1|Date),
data = df_sub, REML = TRUE)
model_list[[tr]] <- model
# Diagnóstico simples
cat("\n===== Treatment:", tr, "=====\n")
r2_vals <- r.squaredGLMM(model)
cat("R² marginal (fixed):", round(r2_vals[1],3),
" | R² conditional (fixed+random):", round(r2_vals[2],3), "\n")
# Residuals vs Fitted
plot(fitted(model), resid(model),
main = paste("Residuals vs Fitted -", tr),
xlab = "Fitted", ylab = "Residuals")
abline(h=0, col="red", lty=2)
}
#| include: false
require(pacman)
p_load(tidyverse,    janitor,     parsedate, sjPlot,
lubridate,    cowplot,    purrr,  readr,      googledrive,    zoo,
dplyr,     stringr,     purrr,  googlesheets4,      arrow,      ggplot2,
ggpubr,     data.table,   patchwork,    sjPlot, Metrics,
yardstick,   lme4,   ggpmisc, matrix, rlang,    scales,   range,
pdp,   sf,   maps, tibble,lmerTest, MuMIn, broom.mixed)
# Set ggplot theme
theme_set(theme_bw())
# -----------------------------
#  Summarise and scale data
# -----------------------------
df_mixed <- L1_flux %>%
mutate(Date = as.Date(datetime)) %>%
group_by(Date, Treat, PORT) %>%
summarise(
FCH4    = median(FCH4, na.rm = TRUE),
FCO2    = median(FCO2, na.rm = TRUE),
SapFlow = median(Js_kgcms, na.rm = TRUE),
Rain    = sum(rain_sum, na.rm = TRUE),
Temp    = median(TS_1, na.rm = TRUE),
SWC     = median(SWC_1, na.rm = TRUE),
GWL     = median(gwl_median, na.rm = TRUE),
VPD     = median(VPD_hour, na.rm = TRUE),
.groups = "drop"
) %>%
filter(complete.cases(.)) %>%
ungroup()
df_mixed$Treat <- factor(df_mixed$Treat)
df_mixed$PORT  <- factor(df_mixed$PORT)
cont_vars <- c("FCH4","FCO2","SapFlow","Rain","Temp","SWC","GWL","VPD")
df_mixed_scaled <- df_mixed
df_mixed_scaled[cont_vars] <- scale(df_mixed[cont_vars])
# -----------------------------
#  Models separated by Treatment
# -----------------------------
treatments <- levels(df_mixed_scaled$Treat)
model_list <- list()
for(tr in treatments){
df_sub <- df_mixed_scaled %>% filter(Treat == tr)
model <- lmer(FCH4 ~ Temp + SWC + GWL + VPD + SapFlow + Rain + FCO2 +
(1|PORT) + (1|Date),
data = df_sub, REML = TRUE)
model_list[[tr]] <- model
# Diagnóstico simples
cat("\n===== Treatment:", tr, "=====\n")
r2_vals <- r.squaredGLMM(model)
cat("R² marginal (fixed):", round(r2_vals[1],3),
" | R² conditional (fixed+random):", round(r2_vals[2],3), "\n")
# Residuals vs Fitted
plot(fitted(model), resid(model),
main = paste("Residuals vs Fitted -", tr),
xlab = "Fitted", ylab = "Residuals")
abline(h=0, col="red", lty=2)
}
# -----------------------------
#  Extracting fixed coeficientes and IC per plot
# -----------------------------
effect_dfs <- lapply(names(model_list), function(tr){
mod <- model_list[[tr]]
df <- tidy(mod, effects="fixed", conf.int=TRUE) %>%
filter(term != "(Intercept)") %>%
mutate(
Treatment = tr,
Sig = ifelse(conf.low*conf.high > 0, TRUE, FALSE),
term = fct_reorder(term, estimate)
)
})
effect_df <- bind_rows(effect_dfs)
# -----------------------------
# Plotting fixed effects
# -----------------------------
treatment_colors <- c("Control"="#7AD151FF","Root-free"="#440154FF")
mml_plot<-ggplot(effect_df, aes(x=term, y=estimate, fill=ifelse(Sig, Treatment, "grey70"))) +
geom_col() +
geom_errorbar(aes(ymin=conf.low, ymax=conf.high), width=0.3) +
coord_flip() +
facet_wrap(~Treatment, scales="free_y", ncol=1) +
scale_fill_manual(values=c(treatment_colors,"grey70"="grey70")) +
labs(x="Predictor", y="Effect size (scaled units)") +
theme_bw() +
theme(strip.background = element_blank(),
panel.grid=element_blank(),
text=element_text(size=14),
legend.position="none"
)
print(mml_plot)
rmle_results<-tab_model(
model_list[["Control"]],
model_list[["Root-free"]],
show.se = TRUE,
show.ci = 0.95,
show.re.var = TRUE,
show.icc = TRUE,
show.r2 = TRUE,
dv.labels = c("Control", "Root-free"),
pred.labels = c(
"Temperature",
"SWC",
"Groundwater level",
"VPD",
"Sap flow",
"Rain",
"CO2 flux"
)
)
print(rmle_results)
library(ggplot2)
res_df <- do.call(rbind, lapply(names(model_list), function(tr){
data.frame(
Residuals = resid(model_list[[tr]]),
Treatment = tr
)
}))
ggplot(res_df, aes(x = Residuals)) +
geom_histogram(bins = 30, fill = "grey70", color = "black") +
facet_wrap(~Treatment, scales = "free") +
theme_bw() +
labs(title = "Histogram of model residuals")
resid(model) ~ Temp
resid(model) ~ SWC
resid(model) ~ GWL
library(ggplot2)
for(tr in names(model_list)){
cat("\n===== Residual diagnostics for:", tr, "=====\n")
df_sub <- df_mixed_scaled %>% filter(Treat == tr)
model  <- model_list[[tr]]
df_diag <- df_sub
df_diag$resid  <- resid(model)
df_diag$fitted <- fitted(model)
predictors <- c("Temp","SWC","GWL","VPD","SapFlow","Rain","FCO2")
for(var in predictors){
p <- ggplot(df_diag, aes_string(x = var, y = "resid")) +
geom_point(alpha = 0.6) +
geom_smooth(method = "loess", se = FALSE, color = "red") +
theme_bw() +
labs(title = paste("Residuals vs", var, "-", tr),
x = var,
y = "Residuals")
print(p)
}
}
for(tr in names(model_list)){
model <- model_list[[tr]]
qqnorm(resid(model),
main = paste("QQ-plot -", tr))
qqline(resid(model), col = "red", lwd = 2)
}
for(tr in names(model_list)){
df_qq <- data.frame(resid = resid(model_list[[tr]]))
p <- ggplot(df_qq, aes(sample = resid)) +
stat_qq() +
stat_qq_line(color = "red") +
theme_bw() +
labs(title = paste("QQ-plot -", tr))
print(p)
}
for(tr in names(model_list)){
model <- model_list[[tr]]
acf(resid(model),
main = paste("ACF of residuals -", tr))
}
for(tr in names(model_list)){
df_sub <- df_mixed_scaled %>% filter(Treat == tr)
model  <- model_list[[tr]]
df_diag <- df_sub
df_diag$resid <- resid(model)
p <- ggplot(df_diag, aes(x = Date, y = resid)) +
geom_point(alpha = 0.6) +
geom_smooth(se = FALSE, color = "red") +
theme_bw() +
labs(title = paste("Residuals vs Date -", tr),
y = "Residuals")
print(p)
}
